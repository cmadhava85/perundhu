<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coordinate Fallback Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background: #f5f5f7;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e1e5e9;
        }
        .test-section h3 {
            margin-top: 0;
            color: #1d1d1f;
        }
        .stop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 6px;
            background: #f8f9fa;
        }
        .stop-item.has-coords {
            background: #e8f5e8;
            border-left: 4px solid #00c752;
        }
        .stop-item.needs-fallback {
            background: #fff3cd;
            border-left: 4px solid #f59e0b;
        }
        .stop-item.fallback-applied {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        .coords {
            font-family: monospace;
            font-size: 12px;
            color: #666;
        }
        .label {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 3px;
            color: white;
            font-weight: bold;
        }
        .exact { background: #00c752; }
        .fallback { background: #f59e0b; }
        .applied { background: #2196f3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üó∫Ô∏è Coordinate Fallback System Test</h1>
        
        <div class="test-section">
            <h3>1. Backend API Response (Raw)</h3>
            <div id="backend-data">Loading...</div>
        </div>
        
        <div class="test-section">
            <h3>2. Frontend Processing (After Fallback)</h3>
            <div id="frontend-processed">Processing...</div>
        </div>
        
        <div class="test-section">
            <h3>3. Map Rendering Status</h3>
            <div id="map-status">Calculating...</div>
        </div>
    </div>

    <script>
        // City coordinates lookup (simplified version)
        const CITY_COORDINATES = {
            'Salem': { name: 'Salem', latitude: 11.6643, longitude: 78.1460, busStandName: 'Salem Central Bus Stand' },
            'Coimbatore': { name: 'Coimbatore', latitude: 11.0168, longitude: 76.9558, busStandName: 'Coimbatore Central Bus Stand' }
        };

        function getCityCoordinates(cityName) {
            return CITY_COORDINATES[cityName] || null;
        }

        function getStopCoordinates(stop) {
            // Use stop coordinates if available
            if (stop.latitude && stop.longitude) {
                return { latitude: stop.latitude, longitude: stop.longitude };
            }
            
            // Fall back to city coordinates
            const cityCoords = getCityCoordinates(stop.name);
            if (cityCoords) {
                return { latitude: cityCoords.latitude, longitude: cityCoords.longitude };
            }
            
            return null;
        }

        function getCoordinateSource(stop, coordinates) {
            if (stop.latitude && stop.longitude) {
                return 'Exact stop location';
            }
            
            const cityCoords = getCityCoordinates(stop.name);
            if (cityCoords && cityCoords.latitude === coordinates.latitude && cityCoords.longitude === coordinates.longitude) {
                return `${cityCoords.busStandName} (city center)`;
            }
            
            return 'Approximate location';
        }

        async function testCoordinateFallback() {
            try {
                // Fetch data from backend
                const response = await fetch('http://localhost:8080/api/v1/bus-schedules/buses/12/stops/basic');
                const stops = await response.json();
                
                // Display backend data
                let backendHtml = `<h4>Bus 12 Stops (${stops.length} total)</h4>`;
                stops.forEach((stop, index) => {
                    const hasCoords = stop.latitude && stop.longitude;
                    const coordsText = hasCoords 
                        ? `(${stop.latitude}, ${stop.longitude})` 
                        : 'NULL - needs fallback';
                    const className = hasCoords ? 'has-coords' : 'needs-fallback';
                    const label = hasCoords 
                        ? '<span class="label exact">EXACT</span>' 
                        : '<span class="label fallback">FALLBACK NEEDED</span>';
                    
                    backendHtml += `
                        <div class="stop-item ${className}">
                            <span>${index + 1}. ${stop.name}</span>
                            <span>
                                ${label}
                                <span class="coords">${coordsText}</span>
                            </span>
                        </div>
                    `;
                });
                document.getElementById('backend-data').innerHTML = backendHtml;
                
                // Process with frontend fallback logic
                let frontendHtml = `<h4>After Frontend Processing</h4>`;
                let processedStops = [];
                
                stops.forEach((stop, index) => {
                    const coords = getStopCoordinates(stop);
                    if (coords) {
                        const source = getCoordinateSource(stop, coords);
                        const isExact = source === 'Exact stop location';
                        const className = isExact ? 'has-coords' : 'fallback-applied';
                        const label = isExact 
                            ? '<span class="label exact">EXACT</span>' 
                            : '<span class="label applied">FALLBACK APPLIED</span>';
                        
                        frontendHtml += `
                            <div class="stop-item ${className}">
                                <span>${index + 1}. ${stop.name}</span>
                                <span>
                                    ${label}
                                    <span class="coords">(${coords.latitude}, ${coords.longitude})</span>
                                </span>
                            </div>
                            <div style="font-size: 11px; color: #666; margin-left: 20px; margin-bottom: 8px;">
                                üìç ${source}
                            </div>
                        `;
                        
                        processedStops.push({ stop, coords, source });
                    } else {
                        frontendHtml += `
                            <div class="stop-item" style="background: #ffebee; border-left: 4px solid #f44336;">
                                <span>${index + 1}. ${stop.name}</span>
                                <span>
                                    <span class="label" style="background: #f44336;">ERROR</span>
                                    <span class="coords">No coordinates found</span>
                                </span>
                            </div>
                        `;
                    }
                });
                document.getElementById('frontend-processed').innerHTML = frontendHtml;
                
                // Map rendering status
                const totalStops = stops.length;
                const stopsWithCoords = processedStops.length;
                const exactStops = processedStops.filter(s => s.source === 'Exact stop location').length;
                const fallbackStops = processedStops.filter(s => s.source !== 'Exact stop location').length;
                
                const mapHtml = `
                    <h4>Map Rendering Summary</h4>
                    <div class="stop-item has-coords">
                        <span>‚úÖ Total stops that can be rendered on map</span>
                        <span><strong>${stopsWithCoords}/${totalStops}</strong></span>
                    </div>
                    <div class="stop-item has-coords">
                        <span>üìç Stops with exact coordinates</span>
                        <span><strong>${exactStops}</strong></span>
                    </div>
                    <div class="stop-item fallback-applied">
                        <span>üéØ Stops using city bus stand coordinates</span>
                        <span><strong>${fallbackStops}</strong></span>
                    </div>
                    ${stopsWithCoords === totalStops 
                        ? '<div style="color: #00c752; font-weight: bold; margin-top: 10px;">üéâ All stops can be displayed on the map!</div>'
                        : '<div style="color: #f44336; font-weight: bold; margin-top: 10px;">‚ö†Ô∏è Some stops cannot be displayed on the map.</div>'
                    }
                `;
                document.getElementById('map-status').innerHTML = mapHtml;
                
            } catch (error) {
                console.error('Test failed:', error);
                document.getElementById('backend-data').innerHTML = `<div style="color: red;">Error: ${error.message}</div>`;
                document.getElementById('frontend-processed').innerHTML = `<div style="color: red;">Error: ${error.message}</div>`;
                document.getElementById('map-status').innerHTML = `<div style="color: red;">Error: ${error.message}</div>`;
            }
        }

        // Run test when page loads
        window.addEventListener('load', testCoordinateFallback);
    </script>
</body>
</html>