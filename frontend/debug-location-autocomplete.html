<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location Autocomplete Debug - 3 Character Requirement</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-input {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            border: 2px solid #ccc;
            border-radius: 4px;
            margin: 10px 0;
        }
        .results {
            margin: 10px 0;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .status {
            padding: 5px 10px;
            border-radius: 4px;
            margin: 5px 0;
        }
        .status.info { background-color: #d1ecf1; }
        .status.success { background-color: #d4edda; }
        .status.warning { background-color: #fff3cd; }
    </style>
</head>
<body>
    <h1>üîç Location Autocomplete Debug Tool</h1>
    <p><strong>New Requirement Testing:</strong> Database check after 3 characters ‚Üí Nominatim cities (not roads)</p>
    
    <div class="test-section">
        <h3>Test Location Autocomplete Behavior</h3>
        <input type="text" class="test-input" id="testInput" 
               placeholder="Type a location name (minimum 3 characters)...">
        
        <div class="status info">
            <strong>Expected Behavior:</strong>
            <br>‚Ä¢ 1-2 characters: No API calls
            <br>‚Ä¢ 3+ characters: Check database first
            <br>‚Ä¢ If database insufficient: Query Nominatim for cities/towns only (not roads)
        </div>
        
        <div id="charCount" class="status info">Characters typed: 0</div>
        <div id="searchStatus" class="status info">Ready to test...</div>
        
        <h4>Results Log:</h4>
        <div id="results" class="results">Waiting for input...</div>
    </div>

    <div class="test-section">
        <h3>Quick Test Cases</h3>
        <button onclick="testCase('Che')">Test 'Che' (3 chars)</button>
        <button onclick="testCase('Arup')">Test 'Arup' (4 chars)</button>
        <button onclick="testCase('Sivakasi')">Test 'Sivakasi' (8 chars)</button>
        <button onclick="testCase('Co')">Test 'Co' (2 chars - should not trigger)</button>
    </div>

    <script>
        let searchCount = 0;
        
        function log(message) {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            results.textContent += `[${timestamp}] ${message}\n`;
            results.scrollTop = results.scrollHeight;
        }
        
        function updateStatus(message, type = 'info') {
            const status = document.getElementById('searchStatus');
            status.textContent = message;
            status.className = `status ${type}`;
        }
        
        // Mock the location autocomplete service to test the 3-character requirement
        async function testLocationSearch(query) {
            searchCount++;
            const searchId = searchCount;
            
            log(`üîç Search #${searchId}: "${query}" (${query.length} characters)`);
            
            if (query.length < 3) {
                log(`‚ùå Search #${searchId}: Query too short (${query.length} < 3). No API call.`);
                updateStatus(`Query too short: ${query.length}/3 characters`, 'warning');
                return [];
            }
            
            updateStatus(`Searching database for "${query}"...`, 'info');
            log(`üìä Search #${searchId}: Checking database first...`);
            
            try {
                // Simulate database check
                const dbResponse = await fetch(`http://localhost:3003/api/v1/bus-schedules/locations/autocomplete?q=${encodeURIComponent(query)}`);
                
                if (dbResponse.ok) {
                    const dbResults = await dbResponse.json();
                    log(`üìä Search #${searchId}: Database returned ${dbResults.length} results`);
                    
                    if (dbResults.length >= 3) {
                        updateStatus(`Found ${dbResults.length} results from database`, 'success');
                        log(`‚úÖ Search #${searchId}: Sufficient database results. Using database only.`);
                        return dbResults.map(r => ({ ...r, source: 'database' }));
                    }
                    
                    log(`üìä Search #${searchId}: Database insufficient (${dbResults.length}). Trying Nominatim for cities...`);
                    updateStatus(`Database: ${dbResults.length} results. Searching Nominatim for cities...`, 'info');
                    
                    // Simulate Nominatim city search
                    log(`üåç Search #${searchId}: Searching Nominatim for cities in "${query}"`);
                    
                    // This would call the actual Nominatim API with city/town restrictions
                    const nominatimQuery = `${query} city Tamil Nadu India`;
                    const nominatimUrl = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(nominatimQuery)}&format=json&countrycodes=in&limit=5&class=place&type=city,town,village`;
                    
                    log(`üåç Search #${searchId}: Nominatim URL: ${nominatimUrl}`);
                    
                    try {
                        const nominatimResponse = await fetch(nominatimUrl, {
                            headers: {
                                'User-Agent': 'Perundhu Bus App Debug Tool'
                            }
                        });
                        
                        if (nominatimResponse.ok) {
                            const nominatimResults = await nominatimResponse.json();
                            const cityResults = nominatimResults.filter(r => 
                                ['city', 'town', 'village', 'hamlet'].includes(r.type) && 
                                r.class === 'place'
                            );
                            
                            log(`üåç Search #${searchId}: Nominatim returned ${nominatimResults.length} total, ${cityResults.length} cities`);
                            
                            const combined = [
                                ...dbResults.map(r => ({ ...r, source: 'database' })),
                                ...cityResults.map(r => ({ 
                                    id: Math.random(), 
                                    name: r.display_name.split(',')[0], 
                                    source: 'nominatim-city' 
                                }))
                            ];
                            
                            updateStatus(`Combined: ${combined.length} results (DB: ${dbResults.length}, Cities: ${cityResults.length})`, 'success');
                            return combined;
                        } else {
                            log(`‚ùå Search #${searchId}: Nominatim API error: ${nominatimResponse.status}`);
                        }
                    } catch (nominatimError) {
                        log(`‚ùå Search #${searchId}: Nominatim error: ${nominatimError.message}`);
                    }
                    
                    updateStatus(`Database only: ${dbResults.length} results`, 'success');
                    return dbResults.map(r => ({ ...r, source: 'database' }));
                } else {
                    log(`‚ùå Search #${searchId}: Database API error: ${dbResponse.status}`);
                }
            } catch (error) {
                log(`‚ùå Search #${searchId}: Error: ${error.message}`);
                updateStatus(`Error: ${error.message}`, 'warning');
            }
            
            return [];
        }
        
        // Set up input handler
        const input = document.getElementById('testInput');
        const charCount = document.getElementById('charCount');
        
        let debounceTimer;
        
        input.addEventListener('input', (e) => {
            const query = e.target.value;
            charCount.textContent = `Characters typed: ${query.length}`;
            
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                if (query.trim()) {
                    testLocationSearch(query.trim());
                }
            }, 300);
        });
        
        function testCase(query) {
            document.getElementById('testInput').value = query;
            document.getElementById('charCount').textContent = `Characters typed: ${query.length}`;
            testLocationSearch(query);
        }
        
        // Initialize
        log('Location Autocomplete Debug Tool Ready');
        log('New requirement: Database check after 3+ characters, then Nominatim cities only');
        log('Type in the input field above or use the test buttons');
    </script>
</body>
</html>