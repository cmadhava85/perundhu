<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nominatim API Test - Improved</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .result { margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 4px; max-height: 300px; overflow-y: auto; }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .query-info { font-style: italic; color: #666; margin: 5px 0; }
    </style>
</head>
<body>
    <h1>üåç Nominatim API Test - Enhanced for "Arup" ‚Üí "Aruppukottai"</h1>
    
    <div class="test-section">
        <h2>Original Query (Failing)</h2>
        <p>This is the query that was not returning results:</p>
        <button onclick="testOriginalQuery()">Test Original Query</button>
        <div id="originalResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>Enhanced Queries (Fixed)</h2>
        <p>These are the improved queries that should work better for partial matches:</p>
        <button onclick="testEnhancedQueries()">Test Enhanced Queries</button>
        <div id="enhancedResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>Wildcard Search Test</h2>
        <p>Testing wildcard approach for partial matches:</p>
        <button onclick="testWildcardSearch()">Test Wildcard Search</button>
        <div id="wildcardResult" class="result"></div>
    </div>

    <script>
        async function testNominatimQuery(query, description) {
            try {
                console.log(`Testing: ${description}`);
                console.log(`Query: ${query}`);
                
                const response = await fetch(`https://nominatim.openstreetmap.org/search?${query}`, {
                    headers: {
                        'User-Agent': 'Perundhu Debug Test'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                
                return {
                    success: true,
                    query,
                    description,
                    count: data.length,
                    results: data,
                    hasAruppukottai: data.some(item => 
                        item.display_name.toLowerCase().includes('aruppukottai')
                    )
                };
            } catch (error) {
                return {
                    success: false,
                    query,
                    description,
                    error: error.message
                };
            }
        }

        async function testOriginalQuery() {
            const resultDiv = document.getElementById('originalResult');
            resultDiv.innerHTML = 'Testing original query...';
            
            // This is the failing query from your original request
            const params = new URLSearchParams({
                q: 'Arupp city, Tamil Nadu, India',
                format: 'json',
                countrycodes: 'in',
                limit: '5',
                addressdetails: '1',
                bounded: '1',
                viewbox: '76.0,8.0,80.5,13.5'
            });
            
            const result = await testNominatimQuery(params.toString(), 'Original failing query');
            displayResult(resultDiv, result);
        }

        async function testEnhancedQueries() {
            const resultDiv = document.getElementById('enhancedResult');
            resultDiv.innerHTML = 'Testing enhanced queries...';
            
            const queries = [
                {
                    params: new URLSearchParams({
                        q: 'Arup* Tamil Nadu',
                        format: 'json',
                        countrycodes: 'in',
                        limit: '8',
                        addressdetails: '1'
                    }),
                    description: 'Wildcard search without bounding box'
                },
                {
                    params: new URLSearchParams({
                        q: 'Arup Tamil Nadu India',
                        format: 'json',
                        countrycodes: 'in',
                        limit: '8',
                        addressdetails: '1'
                    }),
                    description: 'Simple search without restrictions'
                }
            ];
            
            let allResults = [];
            for (const query of queries) {
                const result = await testNominatimQuery(query.params.toString(), query.description);
                allResults.push(result);
                await new Promise(resolve => setTimeout(resolve, 1000)); // Rate limiting
            }
            
            displayMultipleResults(resultDiv, allResults);
        }

        async function testWildcardSearch() {
            const resultDiv = document.getElementById('wildcardResult');
            resultDiv.innerHTML = 'Testing wildcard searches...';
            
            const wildcardQueries = [
                'Arup*',
                'Arup* India',
                'Arup* Tamil Nadu',
                'Arupp*'
            ];
            
            let allResults = [];
            for (const q of wildcardQueries) {
                const params = new URLSearchParams({
                    q: q,
                    format: 'json',
                    countrycodes: 'in',
                    limit: '5',
                    addressdetails: '1'
                });
                
                const result = await testNominatimQuery(params.toString(), `Wildcard: ${q}`);
                allResults.push(result);
                await new Promise(resolve => setTimeout(resolve, 1000)); // Rate limiting
            }
            
            displayMultipleResults(resultDiv, allResults);
        }

        function displayResult(div, result) {
            if (result.success) {
                const className = result.hasAruppukottai ? 'result success' : 'result';
                div.className = className;
                div.innerHTML = `
                    <h4>${result.description}</h4>
                    <p class="query-info">Query: ${decodeURIComponent(result.query)}</p>
                    <p><strong>Results:</strong> ${result.count}</p>
                    <p><strong>Aruppukottai found:</strong> ${result.hasAruppukottai ? '‚úÖ YES' : '‚ùå NO'}</p>
                    <details>
                        <summary>View all results (${result.count})</summary>
                        ${result.results.map(item => `
                            <div style="border: 1px solid #ccc; margin: 5px 0; padding: 5px;">
                                <strong>${item.display_name}</strong><br>
                                Type: ${item.type || 'N/A'}, Class: ${item.class || 'N/A'}
                            </div>
                        `).join('')}
                    </details>
                `;
            } else {
                div.className = 'result error';
                div.innerHTML = `
                    <h4>${result.description}</h4>
                    <p class="query-info">Query: ${decodeURIComponent(result.query)}</p>
                    <p><strong>Error:</strong> ${result.error}</p>
                `;
            }
        }

        function displayMultipleResults(div, results) {
            const hasAnyAruppukottai = results.some(r => r.success && r.hasAruppukottai);
            div.className = hasAnyAruppukottai ? 'result success' : 'result';
            
            div.innerHTML = `
                <h4>Multiple Query Test Results</h4>
                <p><strong>Overall:</strong> ${hasAnyAruppukottai ? '‚úÖ Found Aruppukottai!' : '‚ùå No Aruppukottai found'}</p>
                ${results.map((result, index) => `
                    <div style="border: 1px solid #ddd; margin: 10px 0; padding: 10px;">
                        <h5>Query ${index + 1}: ${result.description}</h5>
                        <p class="query-info">${decodeURIComponent(result.query)}</p>
                        ${result.success ? `
                            <p>Results: ${result.count}, Aruppukottai: ${result.hasAruppukottai ? '‚úÖ' : '‚ùå'}</p>
                            ${result.results.length > 0 ? `
                                <details>
                                    <summary>Results (${result.results.length})</summary>
                                    ${result.results.slice(0, 3).map(item => `
                                        <div>${item.display_name}</div>
                                    `).join('')}
                                </details>
                            ` : ''}
                        ` : `<p style="color: red;">Error: ${result.error}</p>`}
                    </div>
                `).join('')}
            `;
        }

        // Auto-run tests on page load
        window.addEventListener('load', function() {
            console.log('üß™ Starting Nominatim API tests...');
        });
    </script>
</body>
</html>