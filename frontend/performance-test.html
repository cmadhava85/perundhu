<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ Fast Location Autocomplete - Performance Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-section {
            margin: 25px 0;
            padding: 20px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .performance-highlight {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .test-input {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 10px 0;
            transition: border-color 0.3s;
        }
        
        .test-input:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 10px rgba(0,123,255,0.3);
        }
        
        .timing-display {
            font-size: 24px;
            font-weight: bold;
            color: #28a745;
            text-align: center;
            padding: 10px;
            background: #e8f5e8;
            border-radius: 6px;
            margin: 10px 0;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .result-card {
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        
        .database-results { background: #e3f2fd; border-left-color: #2196f3; }
        .nominatim-results { background: #f3e5f5; border-left-color: #9c27b0; }
        
        .test-buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .test-btn {
            padding: 12px 20px;
            font-size: 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .test-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }
        
        .log-container {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Monaco', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
        }
        
        .speed-indicator {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }
        
        .speed-fast { background: #28a745; }
        .speed-medium { background: #ffc107; color: #000; }
        .speed-slow { background: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Fast Location Autocomplete Performance Test</h1>
        
        <div class="performance-highlight">
            <h3>‚ö° Performance Optimizations Applied:</h3>
            <ul>
                <li><strong>Parallel Search:</strong> Database + Nominatim searched simultaneously</li>
                <li><strong>Reduced Debounce:</strong> 50-100ms instead of 150-300ms</li>
                <li><strong>Smart Timeouts:</strong> 2s database, 3s Nominatim with abort control</li>
                <li><strong>Single Query:</strong> One optimized Nominatim call instead of multiple</li>
                <li><strong>Fast Filtering:</strong> Client-side city filtering without API delays</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>üß™ Live Performance Test</h3>
            <input type="text" class="test-input" id="performanceTestInput" 
                   placeholder="Type a location name (e.g., Sattur, Chennai, Arup...)">
            
            <div class="timing-display" id="timingDisplay">‚è±Ô∏è Ready to measure response time...</div>
            
            <div class="test-buttons">
                <button class="test-btn" onclick="performanceTest('Sattur')">Test Sattur</button>
                <button class="test-btn" onclick="performanceTest('Chennai')">Test Chennai</button>
                <button class="test-btn" onclick="performanceTest('Arup')">Test Arup</button>
                <button class="test-btn" onclick="performanceTest('Coimbatore')">Test Coimbatore</button>
                <button class="test-btn" onclick="clearLogs()">Clear Logs</button>
            </div>
        </div>

        <div class="results-grid">
            <div class="result-card database-results">
                <h4>üìä Database Results</h4>
                <div id="databaseResults">Waiting for test...</div>
            </div>
            <div class="result-card nominatim-results">
                <h4>üåç Nominatim Results</h4>
                <div id="nominatimResults">Waiting for test...</div>
            </div>
        </div>

        <div class="test-section">
            <h3>üìù Performance Log</h3>
            <div class="log-container" id="performanceLog">
                üìã Performance monitoring ready. Start typing or use test buttons above...
            </div>
        </div>
    </div>

    <script>
        let testStartTime = 0;
        let logCounter = 0;

        function log(message, type = 'info') {
            logCounter++;
            const logContainer = document.getElementById('performanceLog');
            const timestamp = new Date().toLocaleTimeString();
            const entry = `[${timestamp}] ${logCounter}: ${message}\\n`;
            
            if (logContainer.textContent.includes('Performance monitoring ready')) {
                logContainer.textContent = '';
            }
            
            logContainer.textContent += entry;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateTiming(milliseconds) {
            const timingDisplay = document.getElementById('timingDisplay');
            const speedClass = milliseconds < 500 ? 'speed-fast' : milliseconds < 1500 ? 'speed-medium' : 'speed-slow';
            const speedText = milliseconds < 500 ? 'FAST' : milliseconds < 1500 ? 'MEDIUM' : 'SLOW';
            
            timingDisplay.innerHTML = `
                ‚è±Ô∏è Response Time: <strong>${milliseconds}ms</strong> 
                <span class="speed-indicator ${speedClass}">${speedText}</span>
            `;
        }

        function updateResults(databaseResults, nominatimResults) {
            document.getElementById('databaseResults').innerHTML = `
                <strong>${databaseResults.length} results</strong><br>
                ${databaseResults.slice(0, 3).map(r => `‚Ä¢ ${r.name || r}`).join('<br>')}
                ${databaseResults.length > 3 ? '<br>...' : ''}
            `;
            
            document.getElementById('nominatimResults').innerHTML = `
                <strong>${nominatimResults.length} results</strong><br>
                ${nominatimResults.slice(0, 3).map(r => `‚Ä¢ ${r.name || r}`).join('<br>')}
                ${nominatimResults.length > 3 ? '<br>...' : ''}
            `;
        }

        async function performanceTest(query) {
            testStartTime = performance.now();
            log(`üöÄ Starting performance test for "${query}"`);
            
            // Reset displays
            updateTiming(0);
            updateResults([], []);
            
            try {
                // Simulate the parallel search approach
                log(`üì° Starting parallel database + Nominatim search...`);
                
                const searchPromises = [
                    searchDatabase(query),
                    searchNominatimFast(query)
                ];
                
                const results = await Promise.allSettled(searchPromises);
                const endTime = performance.now();
                const totalTime = Math.round(endTime - testStartTime);
                
                const databaseResults = results[0].status === 'fulfilled' ? results[0].value : [];
                const nominatimResults = results[1].status === 'fulfilled' ? results[1].value : [];
                
                updateTiming(totalTime);
                updateResults(databaseResults, nominatimResults);
                
                log(`‚úÖ Parallel search completed in ${totalTime}ms`);
                log(`üìä Results: DB=${databaseResults.length}, Nominatim=${nominatimResults.length}`);
                
                if (totalTime < 500) {
                    log(`üéâ EXCELLENT performance! Sub-500ms response time achieved.`);
                } else if (totalTime < 1500) {
                    log(`üëç Good performance! Response under 1.5 seconds.`);
                } else {
                    log(`‚ö†Ô∏è Slower than expected. Consider optimizing network conditions.`);
                }
                
            } catch (error) {
                const endTime = performance.now();
                const totalTime = Math.round(endTime - testStartTime);
                updateTiming(totalTime);
                log(`‚ùå Performance test failed after ${totalTime}ms: ${error.message}`);
            }
        }

        async function searchDatabase(query) {
            const startTime = performance.now();
            log(`üìä Database search starting for "${query}"`);
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 2000);
                
                const response = await fetch(`http://localhost:3003/api/v1/bus-schedules/locations/autocomplete?q=${encodeURIComponent(query)}`, {
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const data = await response.json();
                    const duration = Math.round(performance.now() - startTime);
                    log(`üìä Database completed in ${duration}ms with ${data.length} results`);
                    return data;
                } else {
                    log(`‚ùå Database API error: ${response.status}`);
                    return [];
                }
            } catch (error) {
                const duration = Math.round(performance.now() - startTime);
                if (error.name === 'AbortError') {
                    log(`‚è∞ Database search timed out after ${duration}ms`);
                } else {
                    log(`‚ùå Database error after ${duration}ms: ${error.message}`);
                }
                return [];
            }
        }

        async function searchNominatimFast(query) {
            const startTime = performance.now();
            log(`üåç Nominatim search starting for "${query}"`);
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000);
                
                const searchQuery = `${query}, Tamil Nadu, India`;
                const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(searchQuery)}&format=json&countrycodes=in&limit=5&addressdetails=1`;
                
                const response = await fetch(url, {
                    headers: { 'User-Agent': 'Perundhu Bus App Performance Test' },
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const data = await response.json();
                    const duration = Math.round(performance.now() - startTime);
                    
                    // Filter for cities/towns
                    const cityResults = data.filter(result => {
                        const isValidPlace = ['city', 'town', 'village', 'hamlet'].includes(result.type) ||
                                            ['city', 'town', 'village'].includes(result.addresstype);
                        const isNotRoad = result.class !== 'highway' && result.class !== 'landuse' &&
                                         !result.type.includes('road') && result.type !== 'industrial';
                        return isValidPlace && isNotRoad;
                    });
                    
                    const formattedResults = cityResults.map(result => ({
                        name: formatLocationNameSimple(result.display_name),
                        source: 'nominatim'
                    }));
                    
                    log(`üåç Nominatim completed in ${duration}ms with ${formattedResults.length} cities (${data.length} total)`);
                    return formattedResults;
                } else {
                    log(`‚ùå Nominatim API error: ${response.status}`);
                    return [];
                }
            } catch (error) {
                const duration = Math.round(performance.now() - startTime);
                if (error.name === 'AbortError') {
                    log(`‚è∞ Nominatim search timed out after ${duration}ms`);
                } else {
                    log(`‚ùå Nominatim error after ${duration}ms: ${error.message}`);
                }
                return [];
            }
        }

        function formatLocationNameSimple(displayName) {
            if (!displayName || !displayName.includes(',')) {
                return displayName;
            }
            
            const parts = displayName.split(',').map(part => part.trim());
            const cityName = parts[0];
            
            const districtName = parts.find(part => 
                !/(tamil nadu|india|\\d{5,6})/i.test(part) && 
                part !== cityName && 
                part.length > 2
            );
            
            return districtName ? `${cityName}, ${districtName}` : cityName;
        }

        function clearLogs() {
            document.getElementById('performanceLog').textContent = 'üìã Performance log cleared. Ready for new tests...';
            logCounter = 0;
        }

        // Set up live typing test
        const input = document.getElementById('performanceTestInput');
        let typingTimer;
        
        input.addEventListener('input', (e) => {
            const query = e.target.value.trim();
            if (query.length >= 3) {
                clearTimeout(typingTimer);
                typingTimer = setTimeout(() => {
                    performanceTest(query);
                }, 100); // Fast debounce
            }
        });

        // Auto-run a demo test
        setTimeout(() => {
            log('üöÄ Auto-running performance demo with "Chennai"...');
            performanceTest('Chennai');
        }, 1000);
    </script>
</body>
</html>