<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sattur Location Test - Debugging Nominatim Results</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-card {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-input {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 6px;
            margin: 10px 0;
        }
        .test-input:focus {
            border-color: #007bff;
            outline: none;
        }
        .results-container {
            margin: 15px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #007bff;
        }
        .log-entry {
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            margin: 2px 0;
            padding: 2px 5px;
            border-radius: 3px;
        }
        .log-info { background-color: #e3f2fd; }
        .log-success { background-color: #e8f5e8; }
        .log-warning { background-color: #fff3e0; }
        .log-error { background-color: #ffebee; }
        
        .step {
            margin: 10px 0;
            padding: 10px;
            border-radius: 6px;
            border-left: 3px solid #28a745;
            background-color: #f8fff8;
        }
        
        .api-response {
            background-color: #f1f3f4;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 11px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>üîç Sattur Location Test</h1>
    <p><strong>Testing the specific issue:</strong> Sattur location should be found via Nominatim API and returned as autocomplete suggestion</p>
    
    <div class="test-card">
        <h3>Test Input</h3>
        <input type="text" class="test-input" id="locationInput" 
               placeholder="Type 'Sattur' to test..." value="Sattur">
        
        <button onclick="testSattur()" style="padding: 10px 20px; font-size: 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
            üß™ Test Sattur Autocomplete
        </button>
    </div>

    <div class="test-card">
        <h3>üìä Test Steps & Results</h3>
        <div id="testSteps"></div>
    </div>

    <div class="test-card">
        <h3>üåê Raw Nominatim API Response</h3>
        <div id="apiResponse" class="api-response">Click "Test Sattur Autocomplete" to see API response...</div>
    </div>

    <div class="test-card">
        <h3>üèóÔ∏è Processed Results</h3>
        <div id="processedResults" class="results-container">Waiting for test...</div>
    </div>

    <script>
        let testCounter = 0;

        function logStep(message, type = 'info') {
            testCounter++;
            const stepsContainer = document.getElementById('testSteps');
            const stepDiv = document.createElement('div');
            stepDiv.className = 'step';
            stepDiv.innerHTML = `
                <strong>Step ${testCounter}:</strong> ${message}
                <div class="log-entry log-${type}" style="margin-top: 5px;">${new Date().toLocaleTimeString()}</div>
            `;
            stepsContainer.appendChild(stepDiv);
        }

        function displayApiResponse(data) {
            const container = document.getElementById('apiResponse');
            container.innerHTML = `
                <h4>Found ${data.length} results from Nominatim:</h4>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
        }

        function displayProcessedResults(results) {
            const container = document.getElementById('processedResults');
            if (results.length === 0) {
                container.innerHTML = '<div class="log-entry log-error">‚ùå No results after processing</div>';
                return;
            }
            
            container.innerHTML = `
                <h4>‚úÖ Final Autocomplete Results (${results.length}):</h4>
                ${results.map((result, index) => `
                    <div class="log-entry log-success">
                        ${index + 1}. <strong>${result.name}</strong> 
                        <span style="color: #666;">(${result.source}) - Lat: ${result.latitude}, Lng: ${result.longitude}</span>
                    </div>
                `).join('')}
            `;
        }

        async function testSattur() {
            // Clear previous results
            document.getElementById('testSteps').innerHTML = '';
            document.getElementById('apiResponse').innerHTML = 'Testing...';
            document.getElementById('processedResults').innerHTML = 'Processing...';
            testCounter = 0;

            const query = document.getElementById('locationInput').value || 'Sattur';
            
            logStep(`Starting autocomplete test for "${query}"`, 'info');

            try {
                // Step 1: Check database first
                logStep('Checking database for existing locations...', 'info');
                
                let databaseResults = [];
                try {
                    const dbResponse = await fetch(`http://localhost:3003/api/v1/bus-schedules/locations/autocomplete?q=${encodeURIComponent(query)}`);
                    if (dbResponse.ok) {
                        databaseResults = await dbResponse.json();
                        logStep(`Database returned ${databaseResults.length} results`, databaseResults.length > 0 ? 'success' : 'warning');
                    } else {
                        logStep(`Database API error: ${dbResponse.status}`, 'error');
                    }
                } catch (dbError) {
                    logStep(`Database connection error: ${dbError.message}`, 'error');
                }

                // Step 2: Test Nominatim API directly
                logStep('Testing Nominatim API for city results...', 'info');
                
                const nominatimQueries = [
                    `${query}, Tamil Nadu, India`,
                    `${query} city Tamil Nadu India`,
                    `${query} town Tamil Nadu India`
                ];

                let allNominatimResults = [];
                
                for (const searchQuery of nominatimQueries) {
                    logStep(`Querying Nominatim: "${searchQuery}"`, 'info');
                    
                    const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(searchQuery)}&format=json&countrycodes=in&limit=8&addressdetails=1`;
                    
                    try {
                        const response = await fetch(url, {
                            headers: {
                                'User-Agent': 'Perundhu Bus App Debug Tool'
                            }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            logStep(`Nominatim returned ${data.length} results for "${searchQuery}"`, data.length > 0 ? 'success' : 'warning');
                            
                            if (data.length > 0 && allNominatimResults.length === 0) {
                                displayApiResponse(data);
                            }
                            
                            // Filter for cities/towns
                            const cityResults = data.filter(result => {
                                const isValidPlace = (
                                    result.type === 'city' || 
                                    result.type === 'town' || 
                                    result.type === 'village' || 
                                    result.type === 'hamlet' ||
                                    result.addresstype === 'city' ||
                                    result.addresstype === 'town' ||
                                    result.addresstype === 'village'
                                );
                                
                                const isNotRoad = (
                                    result.class !== 'highway' && 
                                    result.class !== 'landuse' &&
                                    !result.type.includes('road') &&
                                    !result.type.includes('street') &&
                                    result.type !== 'industrial'
                                );
                                
                                return isValidPlace && isNotRoad;
                            });
                            
                            logStep(`Filtered to ${cityResults.length} valid city/town results`, cityResults.length > 0 ? 'success' : 'warning');
                            
                            allNominatimResults = allNominatimResults.concat(cityResults.map(result => ({
                                id: Math.random(),
                                name: formatLocationName(result.display_name),
                                latitude: parseFloat(result.lat),
                                longitude: parseFloat(result.lon),
                                source: 'nominatim'
                            })));
                            
                            if (cityResults.length >= 3) {
                                logStep('Got sufficient results, stopping Nominatim search', 'success');
                                break;
                            }
                        } else {
                            logStep(`Nominatim API error: ${response.status}`, 'error');
                        }
                    } catch (error) {
                        logStep(`Nominatim request failed: ${error.message}`, 'error');
                    }
                    
                    // Rate limiting delay
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }

                // Step 3: Combine and display results
                const combinedResults = [
                    ...databaseResults.map(r => ({ ...r, source: 'database' })),
                    ...allNominatimResults
                ];
                
                logStep(`Combined ${combinedResults.length} total results (DB: ${databaseResults.length}, Nominatim: ${allNominatimResults.length})`, combinedResults.length > 0 ? 'success' : 'warning');
                
                if (combinedResults.length > 0) {
                    displayProcessedResults(combinedResults);
                    logStep('‚úÖ Test completed successfully! Results should now appear in autocomplete.', 'success');
                } else {
                    logStep('‚ùå No results found. This indicates an issue with the search logic.', 'error');
                    displayProcessedResults([]);
                }
                
            } catch (error) {
                logStep(`Test failed with error: ${error.message}`, 'error');
                console.error('Test error:', error);
            }
        }

        // Simple location name formatter
        function formatLocationName(displayName) {
            if (!displayName.includes(',')) {
                return displayName.trim();
            }
            
            const parts = displayName.split(',').map(part => part.trim());
            const cityName = parts[0];
            
            // Skip state and country
            const districtName = parts.find(part => 
                !/(tamil nadu|india|\\d{5,6})/i.test(part) && 
                part !== cityName && 
                part.length > 2
            );
            
            return districtName ? `${cityName}, ${districtName}` : cityName;
        }

        // Auto-run test on page load
        window.addEventListener('load', () => {
            setTimeout(testSattur, 1000);
        });
    </script>
</body>
</html>