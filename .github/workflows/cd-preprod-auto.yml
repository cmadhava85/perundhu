name: CD - Auto Deploy to Pre-Production

on:
  push:
    branches: [ main, master ]
    paths:
      - 'frontend/**'
      - 'backend/**'
      - '.github/workflows/cd-preprod-auto.yml'
  workflow_dispatch:

env:
  GCP_PROJECT_ID: astute-strategy-406601
  GCP_REGION: asia-south1
  ARTIFACT_REGISTRY: asia-south1-docker.pkg.dev
  NODE_VERSION: '18'
  JAVA_VERSION: '17'

jobs:
  build-and-push-images:
    name: Build & Push Pre-Prod Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    
    outputs:
      frontend_image: ${{ steps.set-outputs.outputs.frontend_image }}
      backend_image: ${{ steps.set-outputs.outputs.backend_image }}
      commit_sha: ${{ steps.set-outputs.outputs.commit_sha }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: 'gradle'
    
    - name: Build Backend JAR
      working-directory: ./backend
      run: |
        chmod +x gradlew
        ./gradlew build -x test
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCPSECRET }}
    
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
    
    - name: Configure Docker for Artifact Registry
      run: |
        gcloud auth configure-docker ${{ env.ARTIFACT_REGISTRY }}
    
    - name: Build and push images
      id: set-outputs
      run: |
        COMMIT_SHA=$(git rev-parse --short HEAD)
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        TAG="${TIMESTAMP}-${COMMIT_SHA}"
        
        # Frontend
        FRONTEND_IMAGE="${{ env.ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/perundhu/frontend:${TAG}"
        FRONTEND_LATEST="${{ env.ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/perundhu/frontend:preprod-latest"
        docker build -t $FRONTEND_IMAGE -t $FRONTEND_LATEST ./frontend
        docker push $FRONTEND_IMAGE
        docker push $FRONTEND_LATEST
        
        # Backend
        BACKEND_IMAGE="${{ env.ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/perundhu/backend:${TAG}"
        BACKEND_LATEST="${{ env.ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/perundhu/backend:preprod-latest"
        docker build -t $BACKEND_IMAGE -t $BACKEND_LATEST ./backend
        docker push $BACKEND_IMAGE
        docker push $BACKEND_LATEST
        
        echo "frontend_image=$FRONTEND_IMAGE" >> $GITHUB_OUTPUT
        echo "backend_image=$BACKEND_IMAGE" >> $GITHUB_OUTPUT
        echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT

  deploy-to-preprod:
    name: Deploy to Pre-Production
    runs-on: ubuntu-latest
    needs: [build-and-push-images]
    environment:
      name: preprod
      url: https://preprod.perundhu.app
    permissions:
      contents: read
      id-token: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCPSECRET }}
    
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
    
    - name: Set up JDK for Flyway
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: 'gradle'
    
    - name: Deploy Database Migrations
      working-directory: ./backend
      run: |
        chmod +x gradlew
        # Run Flyway migrations for preprod
        ./gradlew flywayMigrate \
          -Dflyway.url="${{ secrets.PREPROD_DB_URL }}" \
          -Dflyway.user="${{ secrets.PREPROD_DB_USER }}" \
          -Dflyway.password="${{ secrets.PREPROD_DB_PASSWORD }}"
    
    - name: Deploy Backend to Pre-Production
      run: |
        gcloud run deploy perundhu-backend-preprod \
          --image ${{ needs.build-and-push-images.outputs.backend_image }} \
          --platform managed \
          --region ${{ env.GCP_REGION }} \
          --allow-unauthenticated \
          --set-env-vars="SPRING_PROFILES_ACTIVE=preprod" \
          --set-secrets="DB_PASSWORD=preprod-db-password:latest,JWT_SECRET=preprod-jwt-secret:latest" \
          --memory 1Gi \
          --cpu 1 \
          --min-instances 0 \
          --max-instances 10 \
          --concurrency 80 \
          --timeout 300s \
          --labels="commit=${{ needs.build-and-push-images.outputs.commit_sha }},env=preprod"
    
    - name: Deploy Frontend to Pre-Production
      run: |
        gcloud run deploy perundhu-frontend-preprod \
          --image ${{ needs.build-and-push-images.outputs.frontend_image }} \
          --platform managed \
          --region ${{ env.GCP_REGION }} \
          --allow-unauthenticated \
          --memory 512Mi \
          --cpu 1 \
          --min-instances 0 \
          --max-instances 5 \
          --concurrency 80 \
          --timeout 60s \
          --labels="commit=${{ needs.build-and-push-images.outputs.commit_sha }},env=preprod"
    
    - name: Get service URLs
      id: urls
      run: |
        BACKEND_URL=$(gcloud run services describe perundhu-backend-preprod --region ${{ env.GCP_REGION }} --format 'value(status.url)')
        FRONTEND_URL=$(gcloud run services describe perundhu-frontend-preprod --region ${{ env.GCP_REGION }} --format 'value(status.url)')
        echo "backend_url=$BACKEND_URL" >> $GITHUB_OUTPUT
        echo "frontend_url=$FRONTEND_URL" >> $GITHUB_OUTPUT
        echo "Backend URL: $BACKEND_URL"
        echo "Frontend URL: $FRONTEND_URL"

  run-preprod-smoke-tests:
    name: Run Pre-Prod Smoke Tests
    runs-on: ubuntu-latest
    needs: [deploy-to-preprod]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCPSECRET }}
    
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
    
    - name: Get service URLs
      run: |
        BACKEND_URL=$(gcloud run services describe perundhu-backend-preprod --region ${{ env.GCP_REGION }} --format 'value(status.url)')
        FRONTEND_URL=$(gcloud run services describe perundhu-frontend-preprod --region ${{ env.GCP_REGION }} --format 'value(status.url)')
        echo "BACKEND_URL=$BACKEND_URL" >> $GITHUB_ENV
        echo "FRONTEND_URL=$FRONTEND_URL" >> $GITHUB_ENV
    
    - name: Wait for services to stabilize
      run: sleep 30
    
    - name: Test Backend Health
      run: |
        echo "Testing Backend Health: ${{ env.BACKEND_URL }}/actuator/health"
        for i in {1..10}; do
          if curl -f -s ${{ env.BACKEND_URL }}/actuator/health; then
            echo "âœ… Backend is healthy"
            exit 0
          fi
          echo "Attempt $i/10 failed, retrying in 10s..."
          sleep 10
        done
        echo "âŒ Backend health check failed after 10 attempts"
        exit 1
    
    - name: Test Frontend
      run: |
        echo "Testing Frontend: ${{ env.FRONTEND_URL }}"
        if curl -f -s ${{ env.FRONTEND_URL }} > /dev/null; then
          echo "âœ… Frontend is accessible"
        else
          echo "âŒ Frontend is not accessible"
          exit 1
        fi
    
    - name: Test API endpoints
      run: |
        echo "Testing API endpoints..."
        # Test locations endpoint (example)
        if curl -f -s ${{ env.BACKEND_URL }}/api/locations > /dev/null; then
          echo "âœ… Locations endpoint works"
        else
          echo "âš ï¸ Locations endpoint returned error (might be expected)"
        fi

  create-deployment-summary:
    name: Create Deployment Summary
    runs-on: ubuntu-latest
    needs: [build-and-push-images, deploy-to-preprod, run-preprod-smoke-tests]
    if: always()
    
    steps:
    - name: Generate summary
      run: |
        echo "## ðŸš€ Pre-Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Deployment Details" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ needs.build-and-push-images.outputs.commit_sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: Pre-Production" >> $GITHUB_STEP_SUMMARY
        echo "- **Deployed by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit SHA**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Docker Images" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Frontend**: ${{ needs.build-and-push-images.outputs.frontend_image }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Backend**: ${{ needs.build-and-push-images.outputs.backend_image }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.run-preprod-smoke-tests.result }}" == "success" ]; then
          echo "âœ… All smoke tests passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Some smoke tests failed" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- Verify the deployment at the pre-production URLs" >> $GITHUB_STEP_SUMMARY
        echo "- Run manual testing if needed" >> $GITHUB_STEP_SUMMARY
        echo "- Create a release to deploy to production" >> $GITHUB_STEP_SUMMARY
