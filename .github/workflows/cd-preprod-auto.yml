name: CD - Auto Deploy to Pre-Production

# Triggered after CI pipeline completes successfully or manually
on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches: [main, master]
  workflow_dispatch:
    inputs:
      deploy_frontend:
        description: 'Deploy Frontend'
        type: boolean
        default: true
      deploy_backend:
        description: 'Deploy Backend'
        type: boolean
        default: true
      deploy_all:
        description: 'Deploy All Services (overrides individual selections)'
        type: boolean
        default: true

# Queue deployments instead of cancelling - let each deployment complete
concurrency:
  group: preprod-deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  GCP_PROJECT_ID: astute-strategy-406601
  GCP_REGION: asia-south1
  ARTIFACT_REGISTRY: asia-south1-docker.pkg.dev
  NODE_VERSION: '18'
  JAVA_VERSION: '17'

jobs:
  # Check if CI passed (skip this check for manual dispatch)
  check-ci-status:
    name: Check CI Status
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    steps:
    - name: Check CI workflow result
      id: check
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "Manual dispatch - proceeding with deployment"
          echo "should_deploy=true" >> $GITHUB_OUTPUT
        elif [ "${{ github.event.workflow_run.conclusion }}" == "success" ]; then
          echo "CI passed - proceeding with deployment"
          echo "should_deploy=true" >> $GITHUB_OUTPUT
        else
          echo "CI did not succeed (status: ${{ github.event.workflow_run.conclusion }}) - skipping deployment"
          echo "should_deploy=false" >> $GITHUB_OUTPUT
        fi

  # Detect which services have changes
  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-latest
    needs: [check-ci-status]
    if: needs.check-ci-status.outputs.should_deploy == 'true'
    outputs:
      frontend: ${{ steps.changes.outputs.frontend }}
      backend: ${{ steps.changes.outputs.backend }}
      migrations: ${{ steps.changes.outputs.migrations }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 2
    
    - name: Detect changes
      id: changes
      run: |
        # For manual dispatch, use input values
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          if [ "${{ inputs.deploy_all }}" == "true" ]; then
            echo "frontend=true" >> $GITHUB_OUTPUT
            echo "backend=true" >> $GITHUB_OUTPUT
            echo "migrations=true" >> $GITHUB_OUTPUT
          else
            echo "frontend=${{ inputs.deploy_frontend }}" >> $GITHUB_OUTPUT
            echo "backend=${{ inputs.deploy_backend }}" >> $GITHUB_OUTPUT
            echo "migrations=${{ inputs.deploy_backend }}" >> $GITHUB_OUTPUT
          fi
          exit 0
        fi
        
        # For push events, detect changes from git diff
        CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || git diff --name-only HEAD)
        
        # Check frontend changes
        if echo "$CHANGED_FILES" | grep -q "^frontend/"; then
          echo "frontend=true" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Frontend changes detected"
        else
          echo "frontend=false" >> $GITHUB_OUTPUT
        fi
        
        # Check backend changes
        if echo "$CHANGED_FILES" | grep -q "^backend/"; then
          echo "backend=true" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Backend changes detected"
        else
          echo "backend=false" >> $GITHUB_OUTPUT
        fi
        
        # Check for database migrations
        if echo "$CHANGED_FILES" | grep -q "^backend/.*migration"; then
          echo "migrations=true" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Database migrations detected"
        else
          echo "migrations=false" >> $GITHUB_OUTPUT
        fi
        
        echo "Changed files:"
        echo "$CHANGED_FILES"

  # Build and push Frontend
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: needs.detect-changes.outputs.frontend == 'true'
    outputs:
      image: ${{ steps.build.outputs.image }}
    permissions:
      contents: read
      id-token: write
    steps:
    - uses: actions/checkout@v4
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCPSECRET }}
    
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
    
    - name: Configure Docker
      run: gcloud auth configure-docker ${{ env.ARTIFACT_REGISTRY }}
    
    - name: Build and push Frontend
      id: build
      run: |
        COMMIT_SHA=$(git rev-parse --short HEAD)
        TAG="$(date +%Y%m%d-%H%M%S)-${COMMIT_SHA}"
        IMAGE="${{ env.ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/perundhu/frontend:${TAG}"
        
        # Get backend URL for frontend build
        BACKEND_URL=$(gcloud run services describe perundhu-backend-preprod --region ${{ env.GCP_REGION }} --format 'value(status.url)' 2>/dev/null || echo "https://perundhu-backend-preprod-1032721240281.asia-south1.run.app")
        echo "Using Backend URL: $BACKEND_URL"
        
        # Get Google Maps API key from Secret Manager
        GOOGLE_MAPS_API_KEY=$(gcloud secrets versions access latest --secret=google-maps-api-key 2>/dev/null || echo "")
        
        # Create .env.local with backend URL and API key (this file is copied into Docker build context)
        echo "VITE_API_URL=${BACKEND_URL}" > ./frontend/.env.local
        echo "VITE_API_BASE_URL=${BACKEND_URL}" >> ./frontend/.env.local
        echo "VITE_GOOGLE_MAPS_API_KEY=${GOOGLE_MAPS_API_KEY}" >> ./frontend/.env.local
        
        # Also create .env.production.local for Vite production build
        echo "VITE_API_URL=${BACKEND_URL}" > ./frontend/.env.production.local
        echo "VITE_API_BASE_URL=${BACKEND_URL}" >> ./frontend/.env.production.local
        echo "VITE_GOOGLE_MAPS_API_KEY=${GOOGLE_MAPS_API_KEY}" >> ./frontend/.env.production.local
        
        echo "Created .env.local and .env.production.local with VITE_API_URL=$BACKEND_URL"
        cat ./frontend/.env.local
        
        # Clear Docker BuildKit cache to avoid corrupted layer issues
        docker builder prune -f --filter "until=24h" || true
        
        # Build with --no-cache to avoid cache corruption issues
        docker build --no-cache -t $IMAGE -t ${{ env.ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/perundhu/frontend:preprod-latest ./frontend
        docker push $IMAGE
        docker push ${{ env.ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/perundhu/frontend:preprod-latest
        
        echo "image=$IMAGE" >> $GITHUB_OUTPUT
        echo "âœ… Frontend image built: $IMAGE"

  # Build and push Backend
  build-backend:
    name: Build Backend
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: needs.detect-changes.outputs.backend == 'true'
    outputs:
      image: ${{ steps.build.outputs.image }}
    permissions:
      contents: read
      id-token: write
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: 'gradle'
    
    - name: Build Backend JAR
      working-directory: ./backend
      run: |
        chmod +x gradlew
        ./gradlew build -x test
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCPSECRET }}
    
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
    
    - name: Configure Docker
      run: gcloud auth configure-docker ${{ env.ARTIFACT_REGISTRY }}
    
    - name: Build and push Backend
      id: build
      run: |
        COMMIT_SHA=$(git rev-parse --short HEAD)
        TAG="$(date +%Y%m%d-%H%M%S)-${COMMIT_SHA}"
        IMAGE="${{ env.ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/perundhu/backend:${TAG}"
        
        # Clear Docker BuildKit cache to avoid corrupted layer issues
        docker builder prune -f --filter "until=24h" || true
        
        # Build with --no-cache to avoid cache corruption issues
        docker build --no-cache -t $IMAGE -t ${{ env.ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/perundhu/backend:preprod-latest ./backend
        docker push $IMAGE
        docker push ${{ env.ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/perundhu/backend:preprod-latest
        
        echo "image=$IMAGE" >> $GITHUB_OUTPUT
        echo "âœ… Backend image built: $IMAGE"

  # Run database migrations (only if backend has changes)
  run-migrations:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    needs: [detect-changes, build-backend]
    if: always() && needs.detect-changes.outputs.migrations == 'true' && needs.build-backend.result != 'failure'
    permissions:
      contents: read
      id-token: write
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: 'gradle'
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCPSECRET }}
    
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
    
    - name: Install Cloud SQL Proxy
      run: |
        wget https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64 -O cloud_sql_proxy
        chmod +x cloud_sql_proxy
    
    - name: Run Flyway Migrations
      working-directory: ./backend
      env:
        FLYWAY_URL: "jdbc:mysql://127.0.0.1:3306/perundhu?useSSL=false&allowPublicKeyRetrieval=true"
        FLYWAY_USER: ${{ secrets.PREPROD_DB_USER }}
        FLYWAY_PASSWORD: ${{ secrets.PREPROD_DB_PASSWORD }}
      run: |
        # Start Cloud SQL Proxy
        ../cloud_sql_proxy -instances=astute-strategy-406601:us-central1:perundhu-preprod-mysql=tcp:3306 &
        sleep 10
        
        chmod +x gradlew
        
        # First repair any failed migrations
        ./gradlew flywayRepair \
          -Pflyway.url="${FLYWAY_URL}" \
          -Pflyway.user="${FLYWAY_USER}" \
          -Pflyway.password="${FLYWAY_PASSWORD}" \
          -Pflyway.locations="classpath:db/migration/mysql" \
          --no-configuration-cache \
          --info || true
        
        # Then run migrations
        ./gradlew flywayMigrate \
          -Pflyway.url="${FLYWAY_URL}" \
          -Pflyway.user="${FLYWAY_USER}" \
          -Pflyway.password="${FLYWAY_PASSWORD}" \
          -Pflyway.locations="classpath:db/migration/mysql" \
          --no-configuration-cache \
          --info
        
        echo "âœ… Database migrations completed"

  # Deploy Frontend
  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: [detect-changes, build-frontend]
    if: always() && needs.detect-changes.outputs.frontend == 'true' && needs.build-frontend.result == 'success'
    permissions:
      contents: read
      id-token: write
    steps:
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCPSECRET }}
    
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
    
    - name: Deploy Frontend to Cloud Run
      run: |
        gcloud run deploy perundhu-frontend-preprod \
          --image ${{ needs.build-frontend.outputs.image }} \
          --platform managed \
          --region ${{ env.GCP_REGION }} \
          --allow-unauthenticated \
          --port 8080 \
          --memory 512Mi \
          --cpu 1 \
          --min-instances 0 \
          --max-instances 5 \
          --concurrency 80 \
          --timeout 60s \
          --cpu-throttling \
          --labels="env=preprod"
        
        echo "âœ… Frontend deployed"

  # Deploy Backend
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    needs: [detect-changes, build-backend, run-migrations]
    if: always() && needs.detect-changes.outputs.backend == 'true' && needs.build-backend.result == 'success' && (needs.run-migrations.result == 'success' || needs.run-migrations.result == 'skipped')
    permissions:
      contents: read
      id-token: write
    steps:
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCPSECRET }}
    
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
    
    - name: Deploy Backend to Cloud Run
      run: |
        gcloud run deploy perundhu-backend-preprod \
          --image ${{ needs.build-backend.outputs.image }} \
          --platform managed \
          --region ${{ env.GCP_REGION }} \
          --allow-unauthenticated \
          --set-env-vars="SPRING_PROFILES_ACTIVE=preprod,GCP_INSTANCE_CONNECTION_NAME=astute-strategy-406601:us-central1:perundhu-preprod-mysql,DB_USERNAME=perundhu_user,MYSQL_USERNAME=perundhu_user,GEMINI_API_ENABLED=true,CORS_ALLOWED_ORIGINS=https://perundhu-frontend-preprod-1032721240281.asia-south1.run.app" \
          --set-secrets="DB_PASSWORD=preprod-db-password:latest,MYSQL_PASSWORD=preprod-db-password:latest,JWT_SECRET=JWT_SECRET_PREPROD:latest,DATA_ENCRYPTION_KEY=DATA_ENCRYPTION_KEY_PREPROD:latest,GEMINI_API_KEY=gemini-api-key:latest,PUBLIC_API_KEY=PUBLIC_API_KEY:latest" \
          --add-cloudsql-instances=astute-strategy-406601:us-central1:perundhu-preprod-mysql \
          --memory 1Gi \
          --cpu 1 \
          --min-instances 0 \
          --max-instances 10 \
          --concurrency 80 \
          --timeout 300s \
          --cpu-throttling \
          --labels="env=preprod"
        
        echo "âœ… Backend deployed"

  # Smoke Tests
  smoke-tests:
    name: Run Smoke Tests
    runs-on: ubuntu-latest
    needs: [detect-changes, deploy-frontend, deploy-backend]
    if: always() && (needs.deploy-frontend.result == 'success' || needs.deploy-backend.result == 'success')
    permissions:
      contents: read
      id-token: write
    steps:
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCPSECRET }}
    
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
    
    - name: Wait for services
      run: sleep 15
    
    - name: Test deployed services
      run: |
        # Test Backend if it was deployed
        if [ "${{ needs.deploy-backend.result }}" == "success" ]; then
          BACKEND_URL=$(gcloud run services describe perundhu-backend-preprod --region ${{ env.GCP_REGION }} --format 'value(status.url)')
          echo "Testing Backend: $BACKEND_URL"
          for i in {1..5}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $BACKEND_URL/actuator/health || echo "000")
            if [ "$HTTP_CODE" -eq "200" ]; then
              echo "âœ… Backend is healthy"
              break
            fi
            sleep 5
          done
        fi
        
        # Test Frontend if it was deployed
        if [ "${{ needs.deploy-frontend.result }}" == "success" ]; then
          FRONTEND_URL=$(gcloud run services describe perundhu-frontend-preprod --region ${{ env.GCP_REGION }} --format 'value(status.url)')
          echo "Testing Frontend: $FRONTEND_URL"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $FRONTEND_URL)
          if [ "$HTTP_CODE" -eq "200" ]; then
            echo "âœ… Frontend is accessible"
          fi
        fi

  # Deployment Summary
  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, build-frontend, build-backend, deploy-frontend, deploy-backend, smoke-tests]
    if: always()
    steps:
    - name: Generate Summary
      run: |
        echo "## ðŸš€ Pre-Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Services Changed" >> $GITHUB_STEP_SUMMARY
        echo "| Service | Changed | Built | Deployed |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|---------|-------|----------|" >> $GITHUB_STEP_SUMMARY
        echo "| Frontend | ${{ needs.detect-changes.outputs.frontend }} | ${{ needs.build-frontend.result || 'skipped' }} | ${{ needs.deploy-frontend.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Backend | ${{ needs.detect-changes.outputs.backend }} | ${{ needs.build-backend.result || 'skipped' }} | ${{ needs.deploy-backend.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Smoke Tests: ${{ needs.smoke-tests.result || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
