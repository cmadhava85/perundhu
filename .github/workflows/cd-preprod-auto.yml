name: CD - Auto Deploy to Pre-Production

# Triggered by CI pipeline on successful build or manually
on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - 'infrastructure/terraform/**'
      - '.github/workflows/terraform.yml'
      - '**.md'
  workflow_dispatch:
  workflow_call:

env:
  GCP_PROJECT_ID: astute-strategy-406601
  GCP_REGION: asia-south1
  ARTIFACT_REGISTRY: asia-south1-docker.pkg.dev
  NODE_VERSION: '18'
  JAVA_VERSION: '17'

jobs:
  build-and-push-images:
    name: Build & Push Pre-Prod Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    
    outputs:
      frontend_image: ${{ steps.set-outputs.outputs.frontend_image }}
      backend_image: ${{ steps.set-outputs.outputs.backend_image }}
      commit_sha: ${{ steps.set-outputs.outputs.commit_sha }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: 'gradle'
    
    - name: Build Backend JAR
      working-directory: ./backend
      run: |
        chmod +x gradlew
        ./gradlew build -x test
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCPSECRET }}
    
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
    
    - name: Configure Docker for Artifact Registry
      run: |
        gcloud auth configure-docker ${{ env.ARTIFACT_REGISTRY }}
    
    - name: Build and push images
      id: set-outputs
      run: |
        COMMIT_SHA=$(git rev-parse --short HEAD)
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        TAG="${TIMESTAMP}-${COMMIT_SHA}"
        
        # Frontend - Build with preprod environment variables
        FRONTEND_IMAGE="${{ env.ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/perundhu/frontend:${TAG}"
        FRONTEND_LATEST="${{ env.ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/perundhu/frontend:preprod-latest"
        
        # Copy preprod env file for build
        cp ./frontend/.env.preprod ./frontend/.env.local
        
        docker build -t $FRONTEND_IMAGE -t $FRONTEND_LATEST ./frontend
        docker push $FRONTEND_IMAGE
        docker push $FRONTEND_LATEST
        
        # Backend
        BACKEND_IMAGE="${{ env.ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/perundhu/backend:${TAG}"
        BACKEND_LATEST="${{ env.ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/perundhu/backend:preprod-latest"
        docker build -t $BACKEND_IMAGE -t $BACKEND_LATEST ./backend
        docker push $BACKEND_IMAGE
        docker push $BACKEND_LATEST
        
        echo "frontend_image=$FRONTEND_IMAGE" >> $GITHUB_OUTPUT
        echo "backend_image=$BACKEND_IMAGE" >> $GITHUB_OUTPUT
        echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT

  deploy-to-preprod:
    name: Deploy to Pre-Production
    runs-on: ubuntu-latest
    needs: [build-and-push-images]
    environment:
      name: preprod
      url: https://preprod.perundhu.app
    permissions:
      contents: read
      id-token: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCPSECRET }}
    
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
    
    - name: Set up JDK for Flyway
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: 'gradle'
    
    - name: Install Cloud SQL Proxy
      run: |
        wget https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64 -O cloud_sql_proxy
        chmod +x cloud_sql_proxy
    
    - name: Start Cloud SQL Proxy
      run: |
        ./cloud_sql_proxy -instances=astute-strategy-406601:us-central1:perundhu-preprod-mysql=tcp:3306 &
        PROXY_PID=$!
        echo "PROXY_PID=$PROXY_PID" >> $GITHUB_ENV
        # Wait for proxy to be ready
        for i in {1..30}; do
          if nc -z 127.0.0.1 3306 2>/dev/null; then
            echo "Cloud SQL Proxy is ready!"
            break
          fi
          echo "Waiting for Cloud SQL Proxy... ($i/30)"
          sleep 2
        done
    
    - name: Deploy Database Migrations
      working-directory: ./backend
      env:
        FLYWAY_URL: "jdbc:mysql://127.0.0.1:3306/perundhu?useSSL=false&allowPublicKeyRetrieval=true"
        FLYWAY_USER: ${{ secrets.PREPROD_DB_USER }}
        FLYWAY_PASSWORD: ${{ secrets.PREPROD_DB_PASSWORD }}
      run: |
        chmod +x gradlew
        # Run Flyway migrations for preprod using Cloud SQL Proxy
        ./gradlew flywayMigrate \
          -Pflyway.url="${FLYWAY_URL}" \
          -Pflyway.user="${FLYWAY_USER}" \
          -Pflyway.password="${FLYWAY_PASSWORD}" \
          -Pflyway.locations="classpath:db/migration/mysql" \
          --no-configuration-cache \
          --info
    
    - name: Deploy Backend to Pre-Production
      run: |
        gcloud run deploy perundhu-backend-preprod \
          --image ${{ needs.build-and-push-images.outputs.backend_image }} \
          --platform managed \
          --region ${{ env.GCP_REGION }} \
          --allow-unauthenticated \
          --set-env-vars="SPRING_PROFILES_ACTIVE=preprod,GCP_INSTANCE_CONNECTION_NAME=astute-strategy-406601:us-central1:perundhu-preprod-mysql,MYSQL_USERNAME=perundhu_user" \
          --set-secrets="MYSQL_PASSWORD=preprod-db-password:latest,JWT_SECRET=preprod-jwt-secret:latest" \
          --add-cloudsql-instances=astute-strategy-406601:us-central1:perundhu-preprod-mysql \
          --memory 1Gi \
          --cpu 1 \
          --min-instances 0 \
          --max-instances 10 \
          --concurrency 80 \
          --timeout 300s \
          --labels="commit=${{ needs.build-and-push-images.outputs.commit_sha }},env=preprod"
    
    - name: Deploy Frontend to Pre-Production
      run: |
        gcloud run deploy perundhu-frontend-preprod \
          --image ${{ needs.build-and-push-images.outputs.frontend_image }} \
          --platform managed \
          --region ${{ env.GCP_REGION }} \
          --allow-unauthenticated \
          --port 8080 \
          --memory 512Mi \
          --cpu 1 \
          --min-instances 0 \
          --max-instances 5 \
          --concurrency 80 \
          --timeout 60s \
          --labels="commit=${{ needs.build-and-push-images.outputs.commit_sha }},env=preprod"
    
    - name: Get service URLs
      id: urls
      run: |
        BACKEND_URL=$(gcloud run services describe perundhu-backend-preprod --region ${{ env.GCP_REGION }} --format 'value(status.url)')
        FRONTEND_URL=$(gcloud run services describe perundhu-frontend-preprod --region ${{ env.GCP_REGION }} --format 'value(status.url)')
        echo "backend_url=$BACKEND_URL" >> $GITHUB_OUTPUT
        echo "frontend_url=$FRONTEND_URL" >> $GITHUB_OUTPUT
        echo "Backend URL: $BACKEND_URL"
        echo "Frontend URL: $FRONTEND_URL"

  run-preprod-smoke-tests:
    name: Run Pre-Prod Smoke Tests
    runs-on: ubuntu-latest
    needs: [deploy-to-preprod]
    
    steps:
    - name: Wait for services to stabilize
      run: sleep 20
    
    - name: Test Backend API
      env:
        BACKEND_URL: https://perundhu-backend-preprod-c6qn3mz4wa-el.a.run.app
      run: |
        echo "Testing Backend API: ${{ env.BACKEND_URL }}/api/v1/bus-schedules"
        for i in {1..10}; do
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.BACKEND_URL }}/api/v1/bus-schedules)
          if [ "$HTTP_CODE" -eq "200" ] || [ "$HTTP_CODE" -eq "404" ]; then
            echo "âœ… Backend API is responding (HTTP $HTTP_CODE)"
            exit 0
          fi
          echo "Attempt $i/10: HTTP $HTTP_CODE, retrying in 10s..."
          sleep 10
        done
        echo "âŒ Backend health check failed after 10 attempts"
        exit 1
    
    - name: Test Frontend
      env:
        FRONTEND_URL: https://perundhu-frontend-preprod-c6qn3mz4wa-el.a.run.app
      run: |
        echo "Testing Frontend: ${{ env.FRONTEND_URL }}"
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.FRONTEND_URL }})
        if [ "$HTTP_CODE" -eq "200" ]; then
          echo "âœ… Frontend is accessible (HTTP $HTTP_CODE)"
        else
          echo "âŒ Frontend returned HTTP $HTTP_CODE"
          exit 1
        fi

  create-deployment-summary:
    name: Create Deployment Summary
    runs-on: ubuntu-latest
    needs: [build-and-push-images, deploy-to-preprod, run-preprod-smoke-tests]
    if: always()
    
    steps:
    - name: Generate summary
      run: |
        echo "## ðŸš€ Pre-Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Deployment Details" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ needs.build-and-push-images.outputs.commit_sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: Pre-Production" >> $GITHUB_STEP_SUMMARY
        echo "- **Deployed by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit SHA**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Docker Images" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Frontend**: ${{ needs.build-and-push-images.outputs.frontend_image }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Backend**: ${{ needs.build-and-push-images.outputs.backend_image }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.run-preprod-smoke-tests.result }}" == "success" ]; then
          echo "âœ… All smoke tests passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Some smoke tests failed" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- Verify the deployment at the pre-production URLs" >> $GITHUB_STEP_SUMMARY
        echo "- Run manual testing if needed" >> $GITHUB_STEP_SUMMARY
        echo "- Create a release to deploy to production" >> $GITHUB_STEP_SUMMARY
