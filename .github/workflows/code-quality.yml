name: Code Quality & Static Analysis

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  JAVA_VERSION: '17'

jobs:
  # Frontend code quality checks
  frontend-quality:
    name: Frontend Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better analysis
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install dependencies
      working-directory: ./frontend
      run: npm ci
    
    - name: ESLint Analysis
      working-directory: ./frontend
      run: |
        npm run lint -- --format json --output-file eslint-report.json || true
        npm run lint || true
      continue-on-error: true
    
    - name: TypeScript Quality Check
      working-directory: ./frontend
      run: npx tsc --noEmit --pretty
      continue-on-error: true
    
    - name: Check for console statements
      working-directory: ./frontend
      run: |
        echo "Checking for console.log statements..."
        if grep -r "console\.log\|console\.error\|console\.warn" src/ --exclude-dir=node_modules || true; then
          echo "âš ï¸ Found console statements. Consider removing them for production."
        else
          echo "âœ… No console statements found"
        fi
      continue-on-error: true
    
    - name: Check for TODO/FIXME comments
      working-directory: ./frontend
      run: |
        echo "Checking for TODO/FIXME comments..."
        grep -r "TODO\|FIXME\|XXX\|HACK" src/ --exclude-dir=node_modules || echo "âœ… No TODO/FIXME found"
      continue-on-error: true
    
    - name: Bundle Size Analysis
      working-directory: ./frontend
      run: |
        npm run build
        echo "## Bundle Size Analysis" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        du -sh dist/ >> $GITHUB_STEP_SUMMARY
        find dist/ -name "*.js" -exec du -h {} \; | sort -rh | head -10 >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
      continue-on-error: true

  # Backend code quality checks
  backend-quality:
    name: Backend Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: 'gradle'
    
    - name: Grant execute permission
      working-directory: ./backend
      run: chmod +x gradlew
    
    - name: SpotBugs Analysis
      working-directory: ./backend
      run: |
        ./gradlew spotbugsMain spotbugsTest || echo "SpotBugs not configured yet"
      continue-on-error: true
    
    - name: Checkstyle Analysis
      working-directory: ./backend
      run: |
        ./gradlew checkstyleMain checkstyleTest || echo "Checkstyle not configured yet"
      continue-on-error: true
    
    - name: Test Coverage Report
      working-directory: ./backend
      run: |
        ./gradlew test jacocoTestReport || true
        echo "## Test Coverage" >> $GITHUB_STEP_SUMMARY
        if [ -f build/reports/jacoco/test/html/index.html ]; then
          echo "Coverage report generated" >> $GITHUB_STEP_SUMMARY
        fi
      continue-on-error: true
    
    - name: Check for System.out.println
      working-directory: ./backend
      run: |
        echo "Checking for System.out.println..."
        grep -r "System\.out\.println\|System\.err\.println" app/src/main --include="*.java" || echo "âœ… No System.out found"
      continue-on-error: true
    
    - name: Check for TODO/FIXME
      working-directory: ./backend
      run: |
        echo "Checking for TODO/FIXME comments..."
        grep -r "TODO\|FIXME\|XXX\|HACK" app/src/main --include="*.java" || echo "âœ… No TODO/FIXME found"
      continue-on-error: true
    
    - name: Dependency Vulnerability Check
      working-directory: ./backend
      run: |
        ./gradlew dependencyCheckAnalyze || echo "OWASP Dependency Check not configured"
      continue-on-error: true

  # CodeQL Analysis - GitHub's free static analysis
  codeql-analysis:
    name: CodeQL Security Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    
    strategy:
      fail-fast: false
      matrix:
        language: [ 'java', 'javascript' ]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: ${{ matrix.language }}
        queries: security-extended,security-and-quality
    
    - name: Autobuild
      uses: github/codeql-action/autobuild@v3
    
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:${{ matrix.language }}"

  # Dependency Review - Checks for vulnerable dependencies
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Dependency Review
      uses: actions/dependency-review-action@v4
      with:
        fail-on-severity: high
        comment-summary-in-pr: always

  # Secret Scanning with TruffleHog
  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: TruffleHog OSS
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.repository.default_branch }}
        head: HEAD
        extra_args: --only-verified

  # License Compliance Check
  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: Install license-checker
      run: npm install -g license-checker
    
    - name: Check Frontend Licenses
      working-directory: ./frontend
      run: |
        npm ci
        echo "## Frontend License Report" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        license-checker --summary >> $GITHUB_STEP_SUMMARY || true
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
      continue-on-error: true

  # Prettier formatting check for frontend
  formatting-check:
    name: Code Formatting Check
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: Check Prettier formatting
      working-directory: ./frontend
      run: |
        npm ci
        npx prettier --check "src/**/*.{js,jsx,ts,tsx,json,css,md}" || echo "âš ï¸ Code formatting issues found"
      continue-on-error: true

  # Summary job
  quality-summary:
    name: Quality Check Summary
    runs-on: ubuntu-latest
    needs: [frontend-quality, backend-quality, codeql-analysis, secret-scan]
    if: always()
    
    steps:
    - name: Create Summary
      run: |
        echo "## ðŸ“Š Code Quality Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Job Results:" >> $GITHUB_STEP_SUMMARY
        echo "- Frontend Quality: ${{ needs.frontend-quality.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Backend Quality: ${{ needs.backend-quality.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- CodeQL Analysis: ${{ needs.codeql-analysis.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Secret Scan: ${{ needs.secret-scan.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Free Tools Used:" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ESLint (JavaScript/TypeScript linting)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… TypeScript Compiler (type checking)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… CodeQL (security analysis)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… TruffleHog (secret detection)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Dependency Review (vulnerability checking)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Prettier (code formatting)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… License Checker (license compliance)" >> $GITHUB_STEP_SUMMARY
