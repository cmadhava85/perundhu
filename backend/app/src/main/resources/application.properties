# Database configuration for MySQL
spring.datasource.url=${DB_URL:jdbc:mysql://localhost:3306/perundhu?createDatabaseIfNotExist=true&useSSL=false&allowPublicKeyRetrieval=true}
spring.datasource.username=${DB_USERNAME:root}
spring.datasource.password=${DB_PASSWORD:root}
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

# Multipart file upload configuration
spring.servlet.multipart.max-file-size=10MB
spring.servlet.multipart.max-request-size=15MB
spring.servlet.multipart.enabled=true

# HikariCP configuration
spring.datasource.hikari.maximum-pool-size=10
spring.datasource.hikari.minimum-idle=5
spring.datasource.hikari.idle-timeout=300000
spring.datasource.hikari.connection-timeout=20000
spring.datasource.hikari.auto-commit=true
spring.datasource.hikari.pool-name=PerundhuHikariCP

# Flyway configuration
spring.flyway.enabled=true
spring.flyway.baseline-on-migrate=true
spring.flyway.clean-on-validation-error=true
spring.flyway.validate-on-migrate=false
spring.flyway.locations=classpath:db/migration

# Profile-specific migration locations - use only one location per profile
spring.flyway.locations=${spring.flyway.locations.${spring.profiles.active:default}}
spring.flyway.locations.test=classpath:db/migration/h2
spring.flyway.locations.default=classpath:db/migration/mysql
spring.flyway.locations.dev=classpath:db/migration/mysql

# Fix circular dependency: Disable JPA validation when Flyway is enabled
spring.jpa.hibernate.ddl-auto=none
spring.jpa.show-sql=${SHOW_SQL:true}
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQLDialect

# Disable schema validation to prevent circular dependency with Flyway
spring.jpa.properties.hibernate.validator.apply_to_ddl=false
spring.jpa.properties.hibernate.temp.use_jdbc_metadata_defaults=false

# ============================================
# HIBERNATE PERFORMANCE OPTIMIZATIONS
# ============================================
# Batch processing - reduces round trips for bulk operations
spring.jpa.properties.hibernate.jdbc.batch_size=25
spring.jpa.properties.hibernate.order_inserts=true
spring.jpa.properties.hibernate.order_updates=true
spring.jpa.properties.hibernate.batch_versioned_data=true

# Fetch size optimization
spring.jpa.properties.hibernate.jdbc.fetch_size=50

# Enable statistics for debugging (disable in production)
spring.jpa.properties.hibernate.generate_statistics=${HIBERNATE_STATS:false}

# Query plan cache (for prepared statements)
spring.jpa.properties.hibernate.query.plan_cache_max_size=2048
spring.jpa.properties.hibernate.query.plan_parameter_metadata_max_size=128

# Let Flyway handle all schema management
spring.sql.init.mode=never
spring.jpa.defer-datasource-initialization=false

# Disable Google Cloud SQL auto-configuration
spring.cloud.gcp.sql.enabled=false
spring.autoconfigure.exclude=com.google.cloud.spring.autoconfigure.sql.GcpCloudSqlAutoConfiguration

# Allow bean definition overriding
spring.main.allow-bean-definition-overriding=true

# Logging configuration
logging.level.root=INFO
logging.level.com.perundhu=DEBUG
logging.level.org.springframework=INFO
logging.level.org.hibernate=INFO
logging.level.com.zaxxer.hikari=DEBUG
logging.level.org.flywaydb=DEBUG

# Feature flags
feature.rewards.enabled=false

# Automatic Approval Configuration
perundhu.automatic-approval.enabled=true
perundhu.automatic-approval.daily-limit=50
perundhu.automatic-approval.trusted-contributors=admin1,admin2,supportTeam1
perundhu.automatic-approval.min-confidence-score=0.8

# Log file configuration
logging.file.name=logs/perundhu.log
logging.file.max-size=10MB
logging.file.max-history=10

# Log pattern configuration
logging.pattern.console=%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n
logging.pattern.file=%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n

# OAuth2 Resource Server Configuration
# For production, set these via environment variables
spring.security.oauth2.resourceserver.jwt.jwk-set-uri=${JWT_JWK_SET_URI:}
spring.security.oauth2.resourceserver.jwt.issuer-uri=${JWT_ISSUER_URI:}

# Security settings
security.require-ssl=${REQUIRE_SSL:false}
security.jwt.secret=${JWT_SECRET:dev-secret-key-change-in-production}

# Development-only settings (remove in production)
spring.security.oauth2.resourceserver.jwt.audiences=${JWT_AUDIENCES:perundhu-api}

# Session management (stateless for JWT)
# Remove session tracking entirely for stateless JWT authentication
# server.servlet.session.tracking-modes=none  # This line causes the error - commenting out
server.servlet.session.persistent=false

# CORS settings for authentication
cors.allowed-origins=${CORS_ALLOWED_ORIGINS:http://localhost:5173,http://localhost:4173}
cors.allowed-methods=${CORS_ALLOWED_METHODS:GET,POST,PUT,DELETE,OPTIONS,HEAD}
cors.allowed-headers=${CORS_ALLOWED_HEADERS:*}
cors.allow-credentials=${CORS_ALLOW_CREDENTIALS:true}
cors.max-age=${CORS_MAX_AGE:3600}

# Enhanced Security Configuration
security.api.rate-limit.enabled=true
security.ip-filtering.enabled=true
security.data.encryption.enabled=true
security.data.encryption.key=${DATA_ENCRYPTION_KEY:}

# Rate limiting configuration
security.rate-limit.public-endpoints=30
security.rate-limit.authenticated-users=300
security.rate-limit.premium-users=1000
security.rate-limit.admin-users=5000

# ============================================
# GUEST USER SECURITY PROTECTION
# ============================================
# Rate Limiting Filter Configuration
rate-limit.enabled=${RATE_LIMIT_ENABLED:true}
rate-limit.read.requests-per-minute=${RATE_LIMIT_READ:100}
rate-limit.write.requests-per-minute=${RATE_LIMIT_WRITE:10}
rate-limit.upload.requests-per-minute=${RATE_LIMIT_UPLOAD:5}

# Origin Validation Filter Configuration
security.origin-validation.enabled=${ORIGIN_VALIDATION_ENABLED:true}
security.origin-validation.strict-mode=${ORIGIN_STRICT_MODE:false}
security.allowed-origins=${CORS_ALLOWED_ORIGINS:http://localhost:5173,http://localhost:4173,https://perundhu.app,https://www.perundhu.app}

# Honeypot Validation Configuration
security.honeypot.enabled=${HONEYPOT_ENABLED:true}

# Google reCAPTCHA v3 Configuration
recaptcha.enabled=${RECAPTCHA_ENABLED:false}
recaptcha.site-key=${RECAPTCHA_SITE_KEY:}
recaptcha.secret-key=${RECAPTCHA_SECRET_KEY:}
recaptcha.score-threshold=${RECAPTCHA_THRESHOLD:0.5}
recaptcha.action=${RECAPTCHA_ACTION:submit}

# API Key Validation Configuration
security.api-key.enabled=${API_KEY_ENABLED:false}
security.api-key.public-key=${PUBLIC_API_KEY:}
security.api-key.strict-mode=${API_KEY_STRICT:false}

# IP filtering configuration  
security.ip-filtering.block-suspicious-agents=true
security.ip-filtering.block-private-networks=false
security.ip-filtering.max-requests-per-second=10
security.ip-filtering.max-unique-endpoints=20

# Data protection settings
security.data.obfuscate-for-non-premium=true
security.data.encrypt-sensitive-endpoints=true
security.data.log-access-attempts=true

# Security monitoring
security.monitoring.enabled=true
security.monitoring.alert-threshold=100
security.monitoring.block-after-violations=5

# Audit logging
security.audit.enabled=true
security.audit.log-file=logs/security-audit.log
security.audit.retention-days=90

# Anti-scraping measures
security.anti-scraping.enabled=true
security.anti-scraping.max-pages-per-session=50
security.anti-scraping.block-automated-tools=true

# Session security
security.session.timeout-minutes=30
security.session.max-concurrent-sessions=3
security.session.invalidate-on-suspicious-activity=true

# Development profile configuration - DISABLE SECURITY FOR TESTING
spring.profiles.active=dev
security.filters.enabled=false
security.ip-filtering.enabled=false
security.monitoring.enabled=false
security.anti-scraping.enabled=false

# File Storage Configuration
app.file.upload-dir=./uploads/images
app.file.max-size=10485760
app.file.base-url=http://localhost:8080

# Gemini Vision AI Configuration (Primary image processing)
# Get your API key from: https://aistudio.google.com/apikey
# Free tier: 15 requests/minute, 1500 requests/day
gemini.api.enabled=${GEMINI_API_ENABLED:true}
gemini.api.key=${GEMINI_API_KEY:AIzaSyAdkcqfn2BLQoG-v8kMlUpFcmYoV_4i_bU}
gemini.api.model=${GEMINI_API_MODEL:gemini-2.0-flash}

# ============================================
# RESILIENCE4J CONFIGURATION
# ============================================
# Circuit Breaker for Gemini Vision API
resilience4j.circuitbreaker.instances.gemini.registerHealthIndicator=true
resilience4j.circuitbreaker.instances.gemini.slidingWindowSize=10
resilience4j.circuitbreaker.instances.gemini.minimumNumberOfCalls=5
resilience4j.circuitbreaker.instances.gemini.failureRateThreshold=50
resilience4j.circuitbreaker.instances.gemini.waitDurationInOpenState=30s
resilience4j.circuitbreaker.instances.gemini.permittedNumberOfCallsInHalfOpenState=3
resilience4j.circuitbreaker.instances.gemini.automaticTransitionFromOpenToHalfOpenEnabled=true
resilience4j.circuitbreaker.instances.gemini.slidingWindowType=COUNT_BASED

# Circuit Breaker for OpenStreetMap/Nominatim API
resilience4j.circuitbreaker.instances.osm.registerHealthIndicator=true
resilience4j.circuitbreaker.instances.osm.slidingWindowSize=10
resilience4j.circuitbreaker.instances.osm.minimumNumberOfCalls=5
resilience4j.circuitbreaker.instances.osm.failureRateThreshold=50
resilience4j.circuitbreaker.instances.osm.waitDurationInOpenState=60s
resilience4j.circuitbreaker.instances.osm.permittedNumberOfCallsInHalfOpenState=2
resilience4j.circuitbreaker.instances.osm.automaticTransitionFromOpenToHalfOpenEnabled=true
resilience4j.circuitbreaker.instances.osm.slidingWindowType=COUNT_BASED

# Circuit Breaker for reCAPTCHA verification
resilience4j.circuitbreaker.instances.recaptcha.registerHealthIndicator=true
resilience4j.circuitbreaker.instances.recaptcha.slidingWindowSize=10
resilience4j.circuitbreaker.instances.recaptcha.minimumNumberOfCalls=3
resilience4j.circuitbreaker.instances.recaptcha.failureRateThreshold=60
resilience4j.circuitbreaker.instances.recaptcha.waitDurationInOpenState=30s
resilience4j.circuitbreaker.instances.recaptcha.permittedNumberOfCallsInHalfOpenState=2
resilience4j.circuitbreaker.instances.recaptcha.automaticTransitionFromOpenToHalfOpenEnabled=true

# Retry Configuration for transient failures
resilience4j.retry.instances.externalApi.maxAttempts=3
resilience4j.retry.instances.externalApi.waitDuration=1s
resilience4j.retry.instances.externalApi.enableExponentialBackoff=true
resilience4j.retry.instances.externalApi.exponentialBackoffMultiplier=2
resilience4j.retry.instances.externalApi.retryExceptions=java.io.IOException,java.net.SocketTimeoutException,java.net.ConnectException

resilience4j.retry.instances.database.maxAttempts=3
resilience4j.retry.instances.database.waitDuration=500ms
resilience4j.retry.instances.database.enableExponentialBackoff=true
resilience4j.retry.instances.database.exponentialBackoffMultiplier=1.5
resilience4j.retry.instances.database.retryExceptions=org.springframework.dao.TransientDataAccessException,java.sql.SQLTransientException

# Bulkhead Configuration (limit concurrent calls)
resilience4j.bulkhead.instances.gemini.maxConcurrentCalls=5
resilience4j.bulkhead.instances.gemini.maxWaitDuration=1s
resilience4j.bulkhead.instances.osm.maxConcurrentCalls=3
resilience4j.bulkhead.instances.osm.maxWaitDuration=500ms

# Time Limiter Configuration
resilience4j.timelimiter.instances.gemini.timeoutDuration=60s
resilience4j.timelimiter.instances.gemini.cancelRunningFuture=true
resilience4j.timelimiter.instances.osm.timeoutDuration=15s
resilience4j.timelimiter.instances.osm.cancelRunningFuture=true

# ============================================
# SPRING BOOT ACTUATOR CONFIGURATION
# ============================================
# Enable health endpoint for monitoring
management.endpoints.web.exposure.include=health,info,circuitbreakers,metrics
management.endpoint.health.show-details=when-authorized
management.endpoint.health.probes.enabled=true

# Health indicator configuration
management.health.circuitbreakers.enabled=true
management.health.db.enabled=true
management.health.diskspace.enabled=true

# Kubernetes/Cloud Run health probes
management.endpoint.health.group.liveness.include=livenessState
management.endpoint.health.group.readiness.include=readinessState,db