# Database configuration for MySQL
spring.datasource.url=${DB_URL:jdbc:mysql://localhost:3306/perundhu?createDatabaseIfNotExist=true&useSSL=false&allowPublicKeyRetrieval=true}
spring.datasource.username=${DB_USERNAME:root}
spring.datasource.password=${DB_PASSWORD:root}
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

# Multipart file upload configuration
spring.servlet.multipart.max-file-size=10MB
spring.servlet.multipart.max-request-size=15MB
spring.servlet.multipart.enabled=true

# HikariCP configuration
spring.datasource.hikari.maximum-pool-size=10
spring.datasource.hikari.minimum-idle=5
spring.datasource.hikari.idle-timeout=300000
spring.datasource.hikari.connection-timeout=20000
spring.datasource.hikari.auto-commit=true
spring.datasource.hikari.pool-name=PerundhuHikariCP

# Flyway configuration
spring.flyway.enabled=true
spring.flyway.baseline-on-migrate=true
spring.flyway.clean-on-validation-error=true
spring.flyway.validate-on-migrate=false
spring.flyway.locations=classpath:db/migration

# Profile-specific migration locations - use only one location per profile
spring.flyway.locations=${spring.flyway.locations.${spring.profiles.active:default}}
spring.flyway.locations.test=classpath:db/migration/h2
spring.flyway.locations.default=classpath:db/migration/mysql
spring.flyway.locations.dev=classpath:db/migration/mysql

# Fix circular dependency: Disable JPA validation when Flyway is enabled
spring.jpa.hibernate.ddl-auto=none
spring.jpa.show-sql=${SHOW_SQL:true}
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQLDialect

# Disable schema validation to prevent circular dependency with Flyway
spring.jpa.properties.hibernate.validator.apply_to_ddl=false
spring.jpa.properties.hibernate.temp.use_jdbc_metadata_defaults=false

# Let Flyway handle all schema management
spring.sql.init.mode=never
spring.jpa.defer-datasource-initialization=false

# Disable Google Cloud SQL auto-configuration
spring.cloud.gcp.sql.enabled=false
spring.autoconfigure.exclude=com.google.cloud.spring.autoconfigure.sql.GcpCloudSqlAutoConfiguration

# Allow bean definition overriding
spring.main.allow-bean-definition-overriding=true

# Logging configuration
logging.level.root=INFO
logging.level.com.perundhu=DEBUG
logging.level.org.springframework=INFO
logging.level.org.hibernate=INFO
logging.level.com.zaxxer.hikari=DEBUG
logging.level.org.flywaydb=DEBUG

# Feature flags
feature.rewards.enabled=false

# Automatic Approval Configuration
perundhu.automatic-approval.enabled=true
perundhu.automatic-approval.daily-limit=50
perundhu.automatic-approval.trusted-contributors=admin1,admin2,supportTeam1
perundhu.automatic-approval.min-confidence-score=0.8

# Log file configuration
logging.file.name=logs/perundhu.log
logging.file.max-size=10MB
logging.file.max-history=10

# Log pattern configuration
logging.pattern.console=%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n
logging.pattern.file=%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n

# OAuth2 Resource Server Configuration
# For production, set these via environment variables
spring.security.oauth2.resourceserver.jwt.jwk-set-uri=${JWT_JWK_SET_URI:}
spring.security.oauth2.resourceserver.jwt.issuer-uri=${JWT_ISSUER_URI:}

# Security settings
security.require-ssl=${REQUIRE_SSL:false}
security.jwt.secret=${JWT_SECRET:dev-secret-key-change-in-production}

# Development-only settings (remove in production)
spring.security.oauth2.resourceserver.jwt.audiences=${JWT_AUDIENCES:perundhu-api}

# Session management (stateless for JWT)
# Remove session tracking entirely for stateless JWT authentication
# server.servlet.session.tracking-modes=none  # This line causes the error - commenting out
server.servlet.session.persistent=false

# CORS settings for authentication
cors.allowed-origins=${CORS_ALLOWED_ORIGINS:http://localhost:5173,http://localhost:4173}
cors.allowed-methods=${CORS_ALLOWED_METHODS:GET,POST,PUT,DELETE,OPTIONS,HEAD}
cors.allowed-headers=${CORS_ALLOWED_HEADERS:*}
cors.allow-credentials=${CORS_ALLOW_CREDENTIALS:true}
cors.max-age=${CORS_MAX_AGE:3600}

# Enhanced Security Configuration
security.api.rate-limit.enabled=true
security.ip-filtering.enabled=true
security.data.encryption.enabled=true
security.data.encryption.key=${DATA_ENCRYPTION_KEY:}

# Rate limiting configuration
security.rate-limit.public-endpoints=30
security.rate-limit.authenticated-users=300
security.rate-limit.premium-users=1000
security.rate-limit.admin-users=5000

# IP filtering configuration  
security.ip-filtering.block-suspicious-agents=true
security.ip-filtering.block-private-networks=false
security.ip-filtering.max-requests-per-second=10
security.ip-filtering.max-unique-endpoints=20

# Data protection settings
security.data.obfuscate-for-non-premium=true
security.data.encrypt-sensitive-endpoints=true
security.data.log-access-attempts=true

# Security monitoring
security.monitoring.enabled=true
security.monitoring.alert-threshold=100
security.monitoring.block-after-violations=5

# Audit logging
security.audit.enabled=true
security.audit.log-file=logs/security-audit.log
security.audit.retention-days=90

# Anti-scraping measures
security.anti-scraping.enabled=true
security.anti-scraping.max-pages-per-session=50
security.anti-scraping.block-automated-tools=true

# Session security
security.session.timeout-minutes=30
security.session.max-concurrent-sessions=3
security.session.invalidate-on-suspicious-activity=true

# Development profile configuration - DISABLE SECURITY FOR TESTING
spring.profiles.active=dev
security.filters.enabled=false
security.ip-filtering.enabled=false
security.monitoring.enabled=false
security.anti-scraping.enabled=false



